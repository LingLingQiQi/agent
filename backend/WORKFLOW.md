# 完整的 ComposeGraph 工作流程图

## 节点说明

```
START
  ↓
UserMessageToMap (转换用户输入)
  ↓
PlanTemplate (规划模板)
  ↓
PlanModel (生成初始TODO list)
  ↓
WritePlan (持久化初始TODO list)
  ↓
ScanTodoList (扫描未完成任务) ←─────────────┐
  ↓                                      │
  分支判断                               │
  ├─ 有未完成任务 → ExecuteTemplate       │
  │                  ↓                  │
  │                ExecuteModel          │
  │                  ↓                  │
  │                分支判断              │
  │                ├─ 需要工具 → ToolsNode │
  │                │          ↓         │
  │                │    (执行工具调用)   │
  │                │          ↓         │
  │                └─ 无工具调用 → MessageToMapForUpdate
  │                              ↓      │
  │                    UpdateTodoListTemplate
  │                              ↓      │
  │                    UpdateTodoListModel (更新TODO状态)
  │                              ↓      │
  │                    WriteUpdatedPlan (持久化更新的TODO)
  │                              ↓      │
  │                              ┌──────┘
  └─ 全部完成 → MapToMapForSummary
                    ↓
            SummaryTemplate (总结模板)
                    ↓
            SummaryModel (生成总结)
                    ↓
                  END
```

## 关键节点功能

### 1. WritePlan 节点
- **功能**: 持久化初始的 TODO list
- **输入**: schema.Message (来自 PlanModel 的 markdown TODO list)
- **输出**: schema.Message (透传给下一个节点)
- **副作用**: 写入 `./data/todolists/{sessionID}.md` 文件

### 2. ScanTodoList 节点  
- **功能**: 扫描最新版本的 TODO list，找到第一个未完成任务
- **输入**: schema.Message (来自 WritePlan 或 WriteUpdatedPlan)
- **输出**: map[string]interface{} 
  - `user_query`: 第一个未完成任务的文本 或 空字符串
  - `message_histories`: 历史消息
- **副作用**: 从磁盘读取最新版本的 TODO list

### 3. WriteUpdatedPlan 节点
- **功能**: 持久化更新后的 TODO list
- **输入**: schema.Message (来自 UpdateTodoListModel 的更新后 TODO list)
- **输出**: schema.Message (透传)
- **副作用**: 写入新版本到 `./data/todolists/{sessionID}.md` 文件
- **特点**: 版本号自动递增，形成任务执行的历史记录

## 循环执行机制

1. **初始化**: PlanModel 生成初始 TODO list
2. **任务循环**: 
   - ScanTodoList 找到下一个未完成任务
   - 如果找到任务 → 执行任务 → 更新状态 → 再次扫描
   - 如果没有任务 → 进入总结流程
3. **版本控制**: 每次更新都创建新版本，保持完整的执行历史

## 文件存储格式

```markdown
# TODO List for Session: {sessionID}

This file contains versioned TODO lists generated by the AI agent.

## Version v1 - 2025-07-22 17:26:46

# 初始计划
- [ ] 任务1：设计数据库
- [ ] 任务2：实现功能

## Version v2 - 2025-07-22 17:27:15

# 更新后计划  
- [x] 任务1：设计数据库 ✅
- [ ] 任务2：实现功能

## Version v3 - 2025-07-22 17:28:30

# 最终计划
- [x] 任务1：设计数据库 ✅
- [x] 任务2：实现功能 ✅
```